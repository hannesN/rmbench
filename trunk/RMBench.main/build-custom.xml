<!--
 $Id: build-custom.xml 679 2008-02-22 08:42:26Z cse $
-->
<project name="RMBench.Obfuscated" default="build.update.jar" basedir=".">

	<property file="version.no"/>
	<property file="${user.home}/.rmbench.build.properties"/>
	
	<property name="temp.folder" value="${basedir}/temp.folder"/>
	<property name="obfuscate.temp" value="${basedir}/temp.obfuscate"/>
	<property name="update.jar" value="com.byterefinery.rmbench_${version.no}.jar"/>
	
	<property name="javacDebugInfo" value="on"/>
	<property name="javacVerbose" value="false"/>
	<property name="javacSource" value="1.4"/>
	<property name="javacTarget" value="1.4"/>
	
	<property name="fail.message1" value="not set. See file RMBench.update/rmbench.build.template.properties for more info"/>
	
	<target name="build.update.jar" description="build the complete jar for the update site">
		<fail unless="eclipse.plugins" message="{eclipse.plugins} ${fail.message1}"/>
		<fail unless="proguard.home" message="{proguard.home} ${fail.message1}"/>
		<fail unless="gef.plugins" message="{gef.plugins} ${fail.message1}"/>
		
		<ant target="build.jars"/>
		
		<move file="RMBench.jar" tofile="RMBench.orig.jar"/>
		<antcall target="obfuscate.rmbench"/>
		<!--
		<zip destfile="RMBench.jar" update="true">
		    <zipfileset src="lib/truelic.jar" excludes="META-INF/MANIFEST.MF"/>
		</zip>
		-->
		
		<ant target="build.update.jar"/>
		<antcall target="fixup.updatejar"/>
		<delete>
			<fileset dir="." includes="RMBench.jar, RMBench.orig.jar"/>
		</delete>
	</target>
	
	<target 
		name="obfuscate.rmbench" 
		description="obfuscate the RMBench and truelic jars into one resulting jar">
		
		<mkdir dir="${obfuscate.temp}"/>
		<taskdef resource="proguard/ant/task.properties" classpath="${proguard.home}/lib/proguard.jar"/>
		<proguard
		        allowaccessmodification="true"
		        usemixedcaseclassnames="false"
		        defaultpackage=""
				optimize="false"
		        skipnonpubliclibraryclasses="false"
		        printseeds="${obfuscate.temp}/obfuscateseeds.txt"
		        printusage="${obfuscate.temp}/obfuscateusage.txt"
                printmapping="${obfuscate.temp}/obfuscatemapping.txt"
                renamesourcefileattribute="SourceFile">
		    <injar name="RMBench.orig.jar"/>
		    <injar name="lib/truelic.jar" filter="!META-INF/MANIFEST.MF"/>
		    <outjar name="RMBench.jar"/>
		    <libraryjar name="${java.home}/lib/rt.jar"/>
			
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.ui_3.3.0.I20070614-0800.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.runtime_3.3.100.v20070530.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.osgi_3.3.0.v20070530.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.equinox.common_3.3.0.v20070426.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.jobs_3.3.1.R33x_v20070709.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.runtime.compatibility.registry_3.2.100.v20070316/runtime_registry_compatibility.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.runtime.compatibility.registry_3.2.100.v20070316"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.equinox.registry_3.3.0.v20070522.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.equinox.preferences_3.2.100.v20070522.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.contenttype_3.2.100.v20070319.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.runtime.compatibility.auth_3.2.100.v20070502.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.equinox.app_1.0.0.v20070606.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.osgi.services_3.1.200.v20070605.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/javax.servlet_2.4.0.v200706111738.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.swt_3.3.0.v3346b.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.swt.gtk.linux.x86_3.3.0.v3346.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.jface_3.3.0.I20070606-0010.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.commands_3.3.0.I20070605-0010.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.ui.workbench_3.3.0.M20070718.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.ui.workbench.compatibility_3.2.0.I20070319-0010/compatibility.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/com.ibm.icu_3.6.1.v20070417.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.help_3.3.0.v20070524.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.expressions_3.3.0.v20070606-0010.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.jface.databinding_1.1.0.I20070606-0010.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.databinding_1.0.1.M20070718.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.resources_3.3.0.v20070604.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.resources.compatibility_3.2.100.v20070502.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.ant.core_3.1.200.v20070522.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.variables_3.2.0.v20070426.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.filesystem_1.1.0.v20070606.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.filesystem.linux.x86_1.1.0.v20070416.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.jface.text_3.3.1.r331_v20070629.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.text_3.3.0.v20070606-0010.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.ui.views_3.2.100.I20070319-0010.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.ui.editors_3.3.1.r331_v20070629.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.ui.ide_3.3.0.I20070620.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.update.configurator_3.2.100.v20070615.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.update.core_3.2.100.v20070615.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.update.core.linux_3.2.0.v20070615.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.net_1.0.1.r33x_20070709.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.update.ui_3.2.100.v20070615.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.ui.forms_3.3.0.v20070511.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.ui.workbench.texteditor_3.3.0.v20070606-0010.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.core.filebuffers_3.3.0.v20070606-0010.jar"/>
			<libraryjar name="${eclipse-3.3.gef.plugins}/org.eclipse.gef_3.2.100.v20070620.jar"/>
			<libraryjar name="${eclipse-3.3.gef.plugins}/org.eclipse.draw2d_3.2.100.v20070529.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.ui.console_3.2.0.v20070530.jar"/>
			<libraryjar name="${eclipse-3.3.plugins}/org.eclipse.compare_3.3.1.r33x_20070709.jar"/>
			<libraryjar name="lib/xpp3-1.1.3.4.N.jar"/>
			<libraryjar name="lib/commons-codec-1.3.jar"/>
			
			<keepattribute name="LineNumberTable"/>
			<keepattribute name="SourceFile"/>
			
			<keep extends="org.eclipse.osgi.util.NLS">
				<field access="static" type="java.lang.String"/>
			</keep>
			<keep name="com.byterefinery.rmbench.RMBenchPlugin"/>
			<keep name="com.byterefinery.rmbench.RMBenchLauncher"/>
			<keep name="com.byterefinery.rmbench.RMBenchPerspective"/>
			<keep name="com.byterefinery.rmbench.model.Model"/>
			<keep name="com.byterefinery.rmbench.preferences.*"/>
			<keep name="com.byterefinery.rmbench.extension.ExtensionManager"/>
			<keep name="com.byterefinery.rmbench.external.*">
				<field access="public protected"/><method access="public protected"/></keep>
			<keep name="com.byterefinery.rmbench.external.model.*">
				<field access="public protected"/><method access="public protected"/></keep>
			<keep name="com.byterefinery.rmbench.external.model.type.*">
				<field access="public protected"/><method access="public protected"/></keep>
			<keep name="com.byterefinery.rmbench.external.export.*">
				<field access="public protected"/><method access="public protected"/></keep>
			<keep name="com.byterefinery.rmbench.external.database.*">
				<field access="public protected"/><method access="public protected"/></keep>
			<keep name="com.byterefinery.rmbench.external.database.jdbc.*">
				<field access="public protected"/><method access="public protected"/></keep>
			<keep name="com.byterefinery.rmbench.external.database.sql99.*">
				<field access="public protected"/><method access="public protected"/></keep>
			<keep name="com.byterefinery.rmbench.external.database.ui.*">
				<field access="public protected"/><method access="public protected"/></keep>
			<keep name="com.byterefinery.rmbench.util.IPublicStore">
				<field access="public protected"/><method access="public protected"/></keep>
			
			<!-- keep rules for RMBench extension implementations -->
			<keep implements="com.byterefinery.rmbench.external.IDatabaseInfo"/>
			<keep implements="com.byterefinery.rmbench.external.IDBAccess"/>
			<keep implements="com.byterefinery.rmbench.external.IDDLFormatter"/>
			<keep implements="com.byterefinery.rmbench.external.IDDLFormatter$Factory"/>
			<keep implements="com.byterefinery.rmbench.external.IDDLGenerator"/>
			<keep implements="com.byterefinery.rmbench.external.IDDLGenerator$Factory"/>
			<keep implements="com.byterefinery.rmbench.external.IDDLGeneratorWizardFactory"/>
			<keep implements="com.byterefinery.rmbench.external.IDDLScript"/>
			<keep implements="com.byterefinery.rmbench.external.IDDLScript$Factory"/>
			<keep implements="com.byterefinery.rmbench.external.IExportable"/>
			<keep implements="com.byterefinery.rmbench.external.IImageExporter"/>
			<keep implements="com.byterefinery.rmbench.external.IMessageProvider"/>
			<keep implements="com.byterefinery.rmbench.external.IMetaDataAccess"/>
			<keep implements="com.byterefinery.rmbench.external.IMetaDataAccess$Factory"/>
			<keep implements="com.byterefinery.rmbench.external.IModelExporter"/>
			<keep implements="com.byterefinery.rmbench.external.IModelExporter$Factory"/>
			<keep implements="com.byterefinery.rmbench.external.IModelExporterWizardFactory"/>
			<keep implements="com.byterefinery.rmbench.external.INameGenerator"/>
			<keep implements="com.byterefinery.rmbench.external.IURLSetupGroup"/>
			<keep implements="com.byterefinery.rmbench.external.IURLSetupGroup$Factory"/>
			<keep implements="com.byterefinery.rmbench.external.IDataTypeEditorFactory"/>
			<keep implements="com.byterefinery.rmbench.external.IExternalJdbcProvider"/>
			<keep implements="com.byterefinery.rmbench.external.database.jdbc.IJdbcConnectAdapter"/>
			<keep implements="com.byterefinery.rmbench.external.database.jdbc.IJdbcConnectAdapter$Factory"/>
			
			<!-- keep rules for Eclipse extension implementations -->
			<keep implements="org.eclipse.ui.IEditorActionBarContributor"/>
			<keep implements="org.eclipse.ui.IEditorPart"/>
			<keep implements="org.eclipse.ui.IEditorInput"/>
			<keep implements="org.eclipse.ui.IElementFactory"/>
			<keep implements="org.eclipse.ui.IViewPart"/>
			<keep implements="org.eclipse.ui.IActionDelegate"/>
			<keep implements="org.eclipse.ui.IExportWizard"/>
			<keep implements="org.eclipse.ui.INewWizard"/>
			<keep implements="org.eclipse.ui.texteditor.IDocumentProvider"/>
			
		    <keep name="de.schlichtherle.license.LicenseContent">
		        <constructor/>
		        <method name="get*"/>
		        <method name="set*"/>
		    </keep>
		    <keep name="de.schlichtherle.xml.GenericCertificate">
		        <constructor/>
		        <method name="get*"/>
		        <method name="set*"/>
		    </keep>
		</proguard>
		
		<!-- put the original Message classes back, because obfuscation somehow messes them up -->
		<unzip src="RMBench.orig.jar" dest="${temp.folder}">
			<patternset includes="**/Messages.class, **/RMBenchMessages.class, **/ExceptionMessages.class"/>
		</unzip>
		<waitfor maxwait="2" maxwaitunit="second">
		    <istrue value="false"/>
		</waitfor>
		<touch >
			<fileset dir="${temp.folder}" includes="**/Messages.class, **/RMBenchMessages.class, **/ExceptionMessages.class"/>
		</touch>
		<zip destfile="RMBench.jar" update="true">
			<zipfileset dir="${temp.folder}" includes="**/Messages.class, **/RMBenchMessages.class, **/ExceptionMessages.class"/>
		</zip>
	</target>
	
	<target name="fixup.updatejar" description="remove references to truelic.jar from the updatesite jar">
		<!-- wait a little so that timestamp diff is > 2 seconds -->
		<waitfor maxwait="3" maxwaitunit="second">
		    <istrue value="false"/>
		</waitfor>
		<copy file="META-INF/MANIFEST.MF" overwrite="true" todir="."/>
		<replaceregexp file="MANIFEST.MF" match=",\s*lib/truelic.jar[^\n\r]*" replace=""/>
		<replaceregexp 
			file="MANIFEST.MF" 
			match="Bundle-Version: [0-9]+(\.[0-9]+)*" 
			replace="Bundle-Version: ${version.no}"/>
		<zip destfile="${update.jar}" update="true">
			<zipfileset file="MANIFEST.MF" prefix="META-INF"/>
		</zip>
		<delete file="MANIFEST.MF"/>
	</target>
	
	<target name="retrace">
		<java fork="true" jar="${proguard.home}/lib/retrace.jar">
			<arg value="-verbose"/>
			<arg value="${obfuscate.temp}/obfuscatemapping.txt"/>
			<arg value="${obfuscate.temp}/stacktrace.txt"/>
		</java>
	</target>
	
	<target name="clean">
		<ant target="clean"/>
	</target>
</project>